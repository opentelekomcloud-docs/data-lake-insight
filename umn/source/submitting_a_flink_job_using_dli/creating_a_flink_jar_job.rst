:original_name: dli_01_0457.html

.. _dli_01_0457:

Creating a Flink Jar Job
========================

A Flink Jar job involves developing a custom application Jar package based on Flink's capabilities and submitting it to a DLI queue for execution.

To create a Flink Jar job, you need to write and build your own application Jar package. This is suitable for users who require stream data processing and are proficient in Flink's secondary development capabilities.

This section describes how to create a Flink Jar job on the DLI management console.

Prerequisites
-------------

-  When you use a Flink Jar job to access other external data sources, such as OpenTSDB, HBase, Kafka, GaussDB(DWS), RDS, CSS, CloudTable, DCS Redis, and DDS, you need to create a datasource connection to connect the job running queue to the external data source.

   -  For details about the external data sources that can be accessed by Flink jobs, see :ref:`Common Development Methods for DLI Cross-Source Analysis <dli_01_0410>`.

   -  For how to create a datasource connection, see :ref:`Configuring the Network Connection Between DLI and Data Sources (Enhanced Datasource Connection) <dli_01_0426>`.

      On the **Resources** > **Queue Management** page, locate the queue you have created, click **More** in the **Operation** column, and select **Test Address Connectivity** to check if the network connection between the queue and the data source is normal. For details, see :ref:`Testing Address Connectivity <dli_01_0489>`.

-  To run a Flink Jar job, you need to build your custom application code into a JAR file and upload it to the OBS bucket that has already been created.
-  Flink dependencies have been built in the DLI server and security hardening has been performed based on the open-source community version. To avoid dependency package compatibility issues or log output and dump issues, be careful to exclude the following files when packaging:

   -  Built-in dependencies (or set the package dependency scope to **provided** in Maven or SBT)
   -  Log configuration files (example, **log4j.properties**/**logback.xml**)
   -  JAR package for log output implementation (example, **log4j**).


Creating a Flink Jar Job
------------------------

#. In the left navigation pane of the DLI management console, choose **Job Management** > **Flink Jobs**. The **Flink Jobs** page is displayed.
#. In the upper right corner of the **Flink Jobs** page, click **Create Job**.
#. Specify job parameters.

   .. table:: **Table 1** Job configuration information

      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Parameter                         | Description                                                                                                                                                                                                                                                                                                         |
      +===================================+=====================================================================================================================================================================================================================================================================================================================+
      | Type                              | Select **Flink Jar**.                                                                                                                                                                                                                                                                                               |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Name                              | Job name. Enter 1 to 57 characters. Only letters, numbers, hyphens (-), and underscores (_) are allowed.                                                                                                                                                                                                            |
      |                                   |                                                                                                                                                                                                                                                                                                                     |
      |                                   | .. note::                                                                                                                                                                                                                                                                                                           |
      |                                   |                                                                                                                                                                                                                                                                                                                     |
      |                                   |    The job name must be globally unique.                                                                                                                                                                                                                                                                            |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Description                       | Description of a job. It can be up to 512 characters long.                                                                                                                                                                                                                                                          |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Tags                              | Tags used to identify cloud resources. A tag includes the tag key and tag value. If you want to use the same tag to identify multiple cloud resources, that is, to select the same tag from the drop-down list box for all services, you are advised to create predefined tags on the Tag Management Service (TMS). |
      |                                   |                                                                                                                                                                                                                                                                                                                     |
      |                                   | For details, see .                                                                                                                                                                                                                                                                                                  |
      |                                   |                                                                                                                                                                                                                                                                                                                     |
      |                                   | .. note::                                                                                                                                                                                                                                                                                                           |
      |                                   |                                                                                                                                                                                                                                                                                                                     |
      |                                   |    -  A maximum of 20 tags can be added.                                                                                                                                                                                                                                                                            |
      |                                   |    -  Only one tag value can be added to a tag key.                                                                                                                                                                                                                                                                 |
      |                                   |    -  The key name in each resource must be unique.                                                                                                                                                                                                                                                                 |
      |                                   |                                                                                                                                                                                                                                                                                                                     |
      |                                   | -  Tag key: Enter a tag key name in the text box.                                                                                                                                                                                                                                                                   |
      |                                   |                                                                                                                                                                                                                                                                                                                     |
      |                                   |    .. note::                                                                                                                                                                                                                                                                                                        |
      |                                   |                                                                                                                                                                                                                                                                                                                     |
      |                                   |       A tag key can contain a maximum of 128 characters. Only letters, numbers, spaces, and special characters ``(_.:+-@)`` are allowed, but the value cannot start or end with a space or start with **\_sys\_**.                                                                                                  |
      |                                   |                                                                                                                                                                                                                                                                                                                     |
      |                                   | -  Tag value: Enter a tag value in the text box.                                                                                                                                                                                                                                                                    |
      |                                   |                                                                                                                                                                                                                                                                                                                     |
      |                                   |    .. note::                                                                                                                                                                                                                                                                                                        |
      |                                   |                                                                                                                                                                                                                                                                                                                     |
      |                                   |       A tag value can contain a maximum of 255 characters. Only letters, numbers, spaces, and special characters ``(_.:+-@)`` are allowed.                                                                                                                                                                          |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

#. Click **OK** to enter the editing page.
#. Select a queue.
#. Configuring Flink Jar Job parameters

   .. table:: **Table 2** Parameters

      +-----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Parameter                         | Description                                                                                                                                                                                                                                                                                          |
      +===================================+======================================================================================================================================================================================================================================================================================================+
      | Queue                             | Select a queue where you want to run your job.                                                                                                                                                                                                                                                       |
      +-----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Application                       | Select a Jar job package.                                                                                                                                                                                                                                                                            |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | There are the following ways to manage JAR files:                                                                                                                                                                                                                                                    |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | -  Upload packages to OBS: Upload Jar packages to an OBS bucket in advance and select the corresponding OBS path.                                                                                                                                                                                    |
      |                                   | -  Upload packages to DLI: Upload JAR files to an OBS bucket in advance and create a package on the **Data Management** > **Package Management** page of the DLI management console. For details, see :ref:`Creating a DLI Package <dli_01_0367>`.                                                   |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | For Flink 1.15 or later, you can only select packages from OBS, instead of DLI.                                                                                                                                                                                                                      |
      +-----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Main Class                        | The name of the JAR package to be loaded, for example, **KafkaMessageStreaming**.                                                                                                                                                                                                                    |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | -  **Default**: Specified based on the **Manifest** file in the JAR package.                                                                                                                                                                                                                         |
      |                                   | -  **Manually assign**: You must enter the class name and confirm the class arguments (separated by spaces).                                                                                                                                                                                         |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | .. note::                                                                                                                                                                                                                                                                                            |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   |    When a class belongs to a package, the main class path must contain the complete package path, for example, **packagePath.KafkaMessageStreaming**.                                                                                                                                                |
      +-----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Class Arguments                   | List of arguments of a specified class. The arguments are separated by spaces.                                                                                                                                                                                                                       |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | Flink parameters support replacement of non-sensitive global variables. For example, if you add the global variable **windowsize** in **Global Configuration** > **Global Variables**, you can add the -**windowsSize {{windowsize}}** parameter for the Flink Jar job.                              |
      +-----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | JAR Package Dependencies          | Select a user-defined package dependency. The dependent program packages are stored in the classpath directory of the cluster.                                                                                                                                                                       |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | There are the following ways to manage JAR files:                                                                                                                                                                                                                                                    |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | -  Upload packages to OBS: Upload Jar packages to an OBS bucket in advance and select the corresponding OBS path.                                                                                                                                                                                    |
      |                                   | -  Upload packages to DLI: Upload JAR files to an OBS bucket in advance and create a package on the **Data Management** > **Package Management** page of the DLI management console. For details, see :ref:`Creating a DLI Package <dli_01_0367>`.                                                   |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | For Flink 1.15 or later, you can only select packages from OBS, instead of DLI.                                                                                                                                                                                                                      |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | When creating a JAR file for a Flink Jar job, you do not need to upload existing built-in dependency packages to avoid package information conflicts.                                                                                                                                                |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | For details about built-in dependency packages, see :ref:`DLI Built-in Dependencies <dli_01_0397>`.                                                                                                                                                                                                  |
      +-----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Other Dependencies                | User-defined dependency files. Other dependency files need to be referenced in the code.                                                                                                                                                                                                             |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | There are the following ways to manage dependency files:                                                                                                                                                                                                                                             |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | -  Upload packages to OBS: Upload dependency files to an OBS bucket in advance and select the corresponding OBS path.                                                                                                                                                                                |
      |                                   | -  Upload packages to DLI: Upload dependency files to an OBS bucket in advance and create a package on the **Data Management** > **Package Management** page of the DLI management console. For details, see :ref:`Creating a DLI Package <dli_01_0367>`.                                            |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | For Flink 1.15 or later, you can only select packages from OBS, instead of DLI.                                                                                                                                                                                                                      |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | You can add the following command to the application to access the corresponding dependency file. In the command, **fileName** indicates the name of the file to be accessed, and **ClassName** indicates the name of the class that needs to access the file.                                       |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | .. code-block::                                                                                                                                                                                                                                                                                      |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   |    ClassName.class.getClassLoader().getResource("userData/fileName")                                                                                                                                                                                                                                 |
      +-----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Flink Version                     | Set **Queue** before setting this parameter.                                                                                                                                                                                                                                                         |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | .. note::                                                                                                                                                                                                                                                                                            |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   |    You are advised not to use Flink of different versions for a long time.                                                                                                                                                                                                                           |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   |    -  Doing so can lead to code incompatibility, which can negatively impact job execution efficiency.                                                                                                                                                                                               |
      |                                   |    -  Doing so may result in job execution failures due to conflicts in dependencies. Jobs rely on specific versions of libraries or components.                                                                                                                                                     |
      +-----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Agency                            | If you choose Flink 1.15 to execute your job, you can create a custom agency to allow DLI to access other services.                                                                                                                                                                                  |
      +-----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Runtime Configuration             | User-defined optimization parameters. The parameter format is **key=value**.                                                                                                                                                                                                                         |
      |                                   |                                                                                                                                                                                                                                                                                                      |
      |                                   | Flink optimization parameters support replacement non-sensitive global variable. For example, if you create global variable **phase** in **Global Configuration** > **Global Variables**, optimization parameter **table.optimizer.agg-phase.strategy={{phase}}** can be added to the Flink Jar job. |
      +-----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

#. Set compute resource specification parameters.

   .. table:: **Table 3** Parameters

      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Parameter                         | Description                                                                                                                                                                                                               |
      +===================================+===========================================================================================================================================================================================================================+
      | CUs                               | One CU consists of one vCPU and 4 GB of memory. The number of CUs ranges from 2 to 10000.                                                                                                                                 |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | .. note::                                                                                                                                                                                                                 |
      |                                   |                                                                                                                                                                                                                           |
      |                                   |    When **Task Manager Config** is selected, elastic resource pool queue management is optimized by automatically adjusting **CUs** to match **Actual CUs** after setting **Slot(s) per TM**.                             |
      |                                   |                                                                                                                                                                                                                           |
      |                                   |    **CUs = Actual number of CUs = max[Job Manager CPUs + Task Manager CPU, (Job Manager Memory + Task Manager Memory/4)]**                                                                                                |
      |                                   |                                                                                                                                                                                                                           |
      |                                   |    -  Job Manager CPUs + Task Manager CPUs = Actual TMs x CU(s) per TM + Job Manager CUs.                                                                                                                                 |
      |                                   |    -  Job Manager Memory + Task Manager Memory = Actual TMs x Memory per TM + Job Manager Memory                                                                                                                          |
      |                                   |    -  If **Slot(s) per TM** is set, then: Actual TMs = Parallelism/Slot(s) per TM.                                                                                                                                        |
      |                                   |    -  If **Slot(s) per TM** is not set, then: Actual TMs = (CUs - Job Manager CUs)/CU(s) per TM.                                                                                                                          |
      |                                   |    -  If **Memory per TM** and **Job Manager Memory** in the optimization parameters are not set, then: Memory per TM = CU(s) per TM x 4. Job Manager Memory = Job Manager CUs x 4.                                       |
      |                                   |    -  The parallelism degree of Spark resources is jointly determined by the number of Executors and the number of Executor CPU cores.                                                                                    |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Job Manager CUs                   | Number of CUs for the job management unit.                                                                                                                                                                                |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Parallelism                       | Number of tasks concurrently executed by each operator in a job.                                                                                                                                                          |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | .. note::                                                                                                                                                                                                                 |
      |                                   |                                                                                                                                                                                                                           |
      |                                   |    -  The value must be less than or equal to four times the number of compute units (CUs minus the number of job manager CUs).                                                                                           |
      |                                   |    -  Set this parameter to a value greater than that configured in the code to avoid job submission failures.                                                                                                            |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Task Manager Config               | Whether Task Manager resource parameters are set                                                                                                                                                                          |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | -  If this option is selected, you need to set the following parameters:                                                                                                                                                  |
      |                                   |                                                                                                                                                                                                                           |
      |                                   |    -  **CU(s) per TM**: Number of resources occupied by each Task Manager.                                                                                                                                                |
      |                                   |    -  **Slot(s) per TM**: Number of slots contained in each Task Manager.                                                                                                                                                 |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | -  If not selected, the system automatically uses the default values.                                                                                                                                                     |
      |                                   |                                                                                                                                                                                                                           |
      |                                   |    -  **CU(s) per TM**: The default value is **1**.                                                                                                                                                                       |
      |                                   |    -  **Slot(s) per TM**: The default value is (Parallelism x CU(s) per TM)/(CUs - Job Manager CUs).                                                                                                                      |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Save Job Log                      | Whether to save the job running logs to the OBS bucket.                                                                                                                                                                   |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | If you select this parameter, you also need to set **OBS Bucket**.                                                                                                                                                        |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | .. caution::                                                                                                                                                                                                              |
      |                                   |                                                                                                                                                                                                                           |
      |                                   |    CAUTION:                                                                                                                                                                                                               |
      |                                   |    You are advised to select this parameter. Otherwise, no run log is generated after the job is executed. If the job is abnormal, the run log cannot be obtained for fault locating.                                     |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | OBS Bucket                        | This parameter is mandatory when you select **Save Job Log**.                                                                                                                                                             |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | Select an OBS bucket to store job logs. If the OBS bucket you select is not authorized, click **Authorize**.                                                                                                              |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Alarm on Job Exception            | Whether to notify users of any job exceptions, such as running exceptions or arrears, via SMS or email.                                                                                                                   |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | If this option is selected, you need to set the following parameters:                                                                                                                                                     |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | **SMN Topic**                                                                                                                                                                                                             |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | Select a custom SMN topic. For how to create a custom SMN topic, see "Creating a Topic" in the *Simple Message Notification User Guide*.                                                                                  |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
      | Auto Restart upon Exception       | Whether automatic restart is enabled. If enabled, jobs will be automatically restarted and restored when exceptions occur.                                                                                                |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | If this option is selected, you need to set the following parameters:                                                                                                                                                     |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | -  **Max. Retry Attempts**: maximum number of retries upon an exception. The unit is times/hour.                                                                                                                          |
      |                                   |                                                                                                                                                                                                                           |
      |                                   |    -  **Unlimited**: The number of retries is unlimited.                                                                                                                                                                  |
      |                                   |    -  **Limited**: The number of retries is user-defined.                                                                                                                                                                 |
      |                                   |                                                                                                                                                                                                                           |
      |                                   | -  **Restore Job from Checkpoint**: Restore the job from the saved checkpoint.                                                                                                                                            |
      |                                   |                                                                                                                                                                                                                           |
      |                                   |    If you select this parameter, you need to set **Checkpoint Path**.                                                                                                                                                     |
      |                                   |                                                                                                                                                                                                                           |
      |                                   |    **Checkpoint Path**: Select the checkpoint save path. This path must match that configured in the application package. Each job must have a unique checkpoint path, or, you will not be able to obtain the checkpoint. |
      +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

#. Click **Save** on the upper right of the page.
#. Click **Start** in the upper right corner. On the displayed **Start Flink Job** page, confirm the job specifications, and click **Start Now** to start the job. After the job is started, the system automatically switches to the **Flink Jobs** page, and the created job is displayed in the job list. You can view the job status in the **Status** column.

   -  Once a job is successfully submitted, its status changes from **Submitting** to **Running**. After the execution is complete, the status changes to **Completed**.
   -  If the job status is **Submission failed** or **Running exception**, the job fails to submit or run. In this case, you can hover over the status icon in the **Status** column of the job list to view the error details. You can click |image1| to copy these details. Rectify the fault based on the error information and resubmit the job.

.. |image1| image:: /_static/images/en-us_image_0207655184.png
